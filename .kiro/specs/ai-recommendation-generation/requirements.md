# 要件定義書

## 概要

この機能は、完了したアンケートセッション（QuestionnaireSession）に対して AI を活用した商品レコメンド生成を実装します。システムは Answer、Question、QuestionOption テーブルからユーザー回答を分析し、Mastra AI と連携してパーソナライズされたレコメンドを生成し、Recommendation テーブルに結果を保存します。生成されたレコメンドは既存の Product テーブル内の楽天商品データと関連付けられ、既存の取得 API（GET /api/recommendations/[sessionId]）を通じてアクセス可能になります。

## 要件

### 要件 1

**ユーザーストーリー:** アンケートを完了したユーザーとして、自分の回答に基づいてシステムが自動的にパーソナライズされた商品レコメンドを生成してほしい。そうすることで、自分の好みやニーズに合った商品を発見できる。

#### 受け入れ基準

1. ユーザーが完了したアンケートセッションのレコメンド生成を要求した時、システムは QuestionnaireSession テーブルでセッションが存在し、status='COMPLETED'であることを検証する
2. セッション検証が通過した時、システムは Answer テーブルから questionnaireSessionId に関連するすべての回答を、Question、QuestionOption との JOIN を含めて取得する
3. 回答が取得された時、システムは質問タイプ（SINGLE_CHOICE、MULTIPLE_CHOICE、RANGE、TEXT）に応じて AI 処理に適した構造化データを作成する
4. データが構造化された時、システムは Category テーブルの情報を基にカテゴリ固有のプロンプトテンプレートを生成する
5. プロンプトが生成された時、システムは Mastra AI サービスにリクエストを送信し、商品レコメンドを要求する
6. AI レスポンスが受信された時、システムはレコメンドデータを解析・検証し、Product テーブル内の商品とのマッピングを実行する
7. レコメンドが検証された時、システムは Recommendation テーブルに rank、score、reason、productId を含むレコードを保存する
8. Recommendation テーブルに既に同じ questionnaireSessionId のレコードが存在する場合、システムは重複生成を防ぐエラーを返す

### 要件 2

**ユーザーストーリー:** システム管理者として、AI レコメンド生成が堅牢でエラーを適切に処理してほしい。そうすることで、外部 AI サービスが利用できない場合でもシステムが安定して動作する。

#### 受け入れ基準

1. Mastra AI サービスが利用できない時、システムはクラッシュすることなく適切なエラーメッセージを返す
2. AI レスポンスが不正または無効な時、システムはエラーをログに記録し、ユーザーフレンドリーなメッセージを返す
3. レコメンド保存中に Prisma トランザクションが失敗した時、システムは部分的な変更をロールバックする
4. レート制限を超過した時、システムは既存のレート制限ミドルウェアを尊重する
5. 認証が失敗した時、システムは適切な認証エラーを返す

### 要件 3

**ユーザーストーリー:** 開発者として、レコメンド生成が設定可能で保守しやすくしてほしい。そうすることで、異なる商品カテゴリに対して AI プロンプトと処理ロジックを簡単に調整できる。

#### 受け入れ基準

1. 異なるアンケートカテゴリを処理する時、システムは Category テーブルの name、description を活用してカテゴリ固有のプロンプトテンプレートを使用する
2. プロンプトを生成する時、システムは UserProfile テーブルの情報と QuestionnaireSession のコンテキストを含める
3. レコメンドを保存する時、システムは Recommendation テーブルで questionnaireSessionId、productId の外部キー制約を維持する
4. 回答を処理する時、システムは QuestionTypeEnum（SINGLE_CHOICE、MULTIPLE_CHOICE、RANGE、TEXT）に応じて適切なデータ抽出を実行する
5. 商品データと統合する時、システムは AI が生成したレコメンド内容を Product テーブル内の商品にマッピングする（name、description、features、ProductCategory テーブルのカテゴリ関連、price 範囲を考慮）

### 要件 4

**ユーザーストーリー:** ユーザーとして、生成されたレコメンドを効率的に取得できるようにしてほしい。そうすることで、パーソナライズされた商品提案に素早くアクセスできる。

#### 受け入れ基準

1. レコメンドが正常に生成された時、システムはセッション詳細を含む成功レスポンスを返す
2. レコメンドが Recommendation テーブルに保存された時、システムは既存の GET /api/recommendations/[sessionId]エンドポイントを通じて即座に利用可能にする
3. 複数のレコメンドが生成された時、システムは Recommendation テーブルの rank フィールドで適切な順序を維持する
4. レコメンドに商品データが含まれる時、システムは Product テーブルとの JOIN を通じて必要なすべての商品情報がアクセス可能であることを保証する

### 要件 5

**ユーザーストーリー:** 開発者として、AI が生成したレコメンド内容を既存商品に効率的にマッピングする仕組みがほしい。そうすることで、適切な商品を正確にユーザーに提案できる。

#### 受け入れ基準

1. AI が商品レコメンドを生成する時、システムは Product テーブルの商品情報（name、description、features）と ProductCategory テーブルのカテゴリ関連を含む構造化された情報を提供する
2. 商品マッピング処理を行う時、システムは Product テーブルの name、description、features フィールドを使用して最適なマッチングを実行する
3. マッピング精度を向上させるため、システムは ProductCategory テーブルを活用してカテゴリ情報で検索範囲を絞り込む
4. マッピング結果を検証する時、システムは信頼度スコアを算出し、閾値以下の場合は代替手法を使用する
5. マッピングが失敗した場合、システムは適切なフォールバック処理を実行し、エラーログを記録する

### 要件 6

**ユーザーストーリー:** システム運用者として、AI レコメンドプロセスの包括的なログ記録と監視機能がほしい。そうすることで、問題のトラブルシューティングとシステムパフォーマンスの監視ができる。

#### 受け入れ基準

1. レコメンド生成が開始された時、システムはセッション ID とユーザーコンテキストをログに記録する
2. AI リクエストが作成された時、システムはリクエスト詳細とレスポンス時間をログに記録する
3. エラーが発生した時、システムはスタックトレースを含む詳細なエラー情報をログに記録する
4. レコメンドが正常に生成された時、システムは件数と基本メタデータをログに記録する
5. データベース操作が完了した時、システムは監査目的でトランザクション詳細をログに記録する

### 要件 7

**ユーザーストーリー:** 開発者として、既存の API エンドポイントとの整合性を保ちながらレコメンド機能を拡張したい。そうすることで、フロントエンドの変更を最小限に抑えながら新機能を提供できる。

#### 受け入れ基準

1. レコメンド生成が完了した時、システムは既存の GET /api/recommendations/[sessionId]エンドポイントのレスポンス形式と互換性を保つ
2. Recommendation テーブルのスキーマが変更された時、システムは既存の API レスポンスマッピングを適切に更新する
3. エラーレスポンスを返す時、システムは既存の ErrorCodes と createErrorResponse 関数を使用する
4. 成功レスポンスを返す時、システムは既存の createSuccessResponse 関数と setSecurityHeaders 関数を使用する
5. 認証とレート制限を処理する時、システムは既存の requireAuth と rateLimit ミドルウェアを使用する
