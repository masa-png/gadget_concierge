# 実装計画

- [x] 1. プロジェクト基盤と Mastra AI 統合の準備

  - Mastra AI 依存関係の追加とクライアント設定を実装
  - 環境変数とコンフィグファイルを作成
  - _要件: 1.5, 2.1_

- [x] 2. 回答データ処理サービスの実装

  - [x] 2.1 回答データ取得と JOIN クエリの実装

    - QuestionnaireSession、Answer、Question、QuestionOption テーブルからのデータ取得機能を実装
    - Prisma クエリでの効率的な JOIN 処理を作成
    - _要件: 1.2, 1.3_

  - [x] 2.2 質問タイプ別データ構造化の実装
    - SINGLE_CHOICE、MULTIPLE_CHOICE、RANGE、TEXT タイプの処理ロジックを実装
    - AI 処理に適した統一データ形式への変換機能を作成
    - _要件: 1.3, 3.4_

- [x] 3. プロンプト生成サービスの実装

  - [x] 3.1 カテゴリ別プロンプトテンプレートシステムの構築

    - Category テーブルの情報を活用したテンプレート管理機能を実装
    - カテゴリ固有のプロンプト生成ロジックを作成
    - _要件: 1.4, 3.1, 3.2_

  - [x] 3.2 ユーザーコンテキスト統合機能の実装
    - UserProfile テーブルの情報をプロンプトに組み込む機能を実装
    - 構造化された回答データをプロンプトに変換する処理を作成
    - _要件: 1.4, 3.2_

- [x] 4. Mastra AI 連携サービスの実装

  - [x] 4.1 Mastra AI クライアントとリクエスト処理の実装

    - Mastra AI API への HTTP リクエスト機能を実装
    - タイムアウト、リトライ、エラーハンドリングを含む堅牢な通信処理を作成
    - _要件: 1.5, 2.1, 2.2_

  - [x] 4.2 AI レスポンス検証と解析機能の実装
    - AI からのレスポンスデータの構造検証を実装
    - レコメンドデータの解析と正規化処理を作成
    - _要件: 1.6, 2.2_

- [ ] 5. 商品マッピングサービスの実装

  - [ ] 5.1 商品検索とマッチングアルゴリズムの実装

    - Product テーブルでの商品名、説明、特徴による検索機能を実装
    - ProductCategory テーブルを活用したカテゴリ絞り込み機能を作成
    - _要件: 1.6, 5.2, 5.3_

  - [ ] 5.2 マッチング信頼度評価システムの実装
    - 商品マッチングの信頼度スコア算出機能を実装
    - 閾値以下の場合のフォールバック処理を作成
    - _要件: 5.4, 5.5_

- [ ] 6. レコメンド保存サービスの実装

  - [ ] 6.1 重複チェックとデータ保存機能の実装

    - Recommendation テーブルでの既存レコメンド確認機能を実装
    - rank、score、reason、productId を含むレコード保存処理を作成
    - _要件: 1.7, 1.8, 3.3_

  - [ ] 6.2 トランザクション管理とエラーハンドリングの実装
    - Prisma トランザクションでの一括保存処理を実装
    - 部分的な変更のロールバック機能を作成
    - _要件: 2.3, 6.5_

- [ ] 7. メイン API エンドポイントの実装

  - [ ] 7.1 POST /api/recommendations/generate エンドポイントの基本構造実装

    - 既存のミドルウェア（requireAuth、rateLimit）を統合
    - リクエストバリデーションとレスポンス形式を実装
    - _要件: 7.3, 7.4, 7.5_

  - [ ] 7.2 サービス統合とメインフローの実装
    - 各サービスクラスを統合したメイン処理フローを実装
    - エラーハンドリングとログ記録機能を組み込み
    - _要件: 4.1, 6.1, 6.2, 6.3, 6.4_

- [ ] 8. エラーハンドリングとログ機能の実装

  - [ ] 8.1 包括的なエラーハンドリングシステムの実装

    - バリデーション、外部サービス、データベース、マッピングエラーの分類処理を実装
    - 適切な HTTP ステータスコードとエラーメッセージの返却機能を作成
    - _要件: 2.1, 2.2, 2.3, 2.5_

  - [ ] 8.2 構造化ログとモニタリング機能の実装
    - セッション ID、ユーザーコンテキスト、処理時間を含むログ記録機能を実装
    - エラー詳細とスタックトレースの記録機能を作成
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 9. 設定管理とセキュリティ機能の実装

  - [ ] 9.1 環境変数と設定ファイルの実装

    - Mastra AI 設定、レコメンド設定、タイムアウト設定を含む設定管理を実装
    - 設定値の検証と初期化処理を作成
    - _要件: 2.1, 3.1_

  - [ ] 9.2 セキュリティ機能の実装
    - 入力サニタイゼーションと PII 除去機能を実装
    - API キー管理とタイムアウト制御を作成
    - _要件: 7.5_

- [ ] 10. テスト実装

  - [ ] 10.1 ユニットテストの実装

    - 各サービスクラスの個別機能テストを作成
    - モックを使用した外部依存関係の分離テストを実装
    - _要件: 全要件のテストカバレッジ_

  - [ ] 10.2 統合テストの実装
    - API エンドポイント全体のフローテストを作成
    - データベーストランザクションの整合性テストを実装
    - _要件: 4.2, 7.1, 7.2_

- [ ] 11. 既存 API との統合テスト

  - [ ] 11.1 GET /api/recommendations/[sessionId] との連携確認

    - 生成されたレコメンドが既存 API で正しく取得できることを確認
    - レスポンス形式の互換性テストを実行
    - _要件: 4.2, 7.1, 7.2_

  - [ ] 11.2 エンドツーエンドテストの実装
    - フロントエンドからの完全なレコメンド生成フローテストを作成
    - エラーシナリオでの適切な処理確認テストを実装
    - _要件: 全要件の統合テスト_

- [ ] 12. パフォーマンス最適化とドキュメント作成

  - [ ] 12.1 パフォーマンス最適化の実装

    - データベースクエリの最適化とインデックス活用を実装
    - AI 呼び出しとメモリ使用量の最適化を実行
    - _要件: パフォーマンス要件_

  - [ ] 12.2 API ドキュメントとデプロイ準備
    - API エンドポイントの詳細ドキュメントを作成
    - 環境変数設定ガイドとデプロイ手順書を作成
    - _要件: 運用要件_
